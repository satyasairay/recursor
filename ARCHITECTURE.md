# RECURSOR ‚Äî Architecture & Vocabulary

## Phase 0: Foundation Stabilization ‚úÖ

This document defines the core architecture, data structures, and vocabulary that powers RECURSOR's recursive experience engine.

---

## üìê Core Vocabulary

### Pattern
A **Pattern** is a linear sequence of cells representing the current puzzle state.
- Type: `number[]` (array of integers)
- Each value represents a cell's evolution state (0-3)
- Patterns evolve through user interaction and historical analysis
- Patterns are always flat arrays for consistency and predictability

**Example:**
```typescript
const pattern: Pattern = [0, 1, 2, 1, 0, 1, 2, 3, 0];
```

### Cell
A **Cell** is a single interactive unit within a pattern.
- Each cell has a state (0-3) representing its evolution level
- States:
  - `0` = Empty/dormant
  - `1` = Awakening  
  - `2` = Active
  - `3` = Complete/mature (triggers portal when all cells reach this)

**Visual representation:**
- State 0: `‚óã` (empty circle)
- State 1: `‚óè` (one filled dot)
- State 2: `‚óè‚óè` (two filled dots)
- State 3: `‚óè‚óè‚óè` (three filled dots + fractal corner markers)

### Depth
**Recursion Depth** tracks how many recursive layers deep the user has descended.
- Type: `number`
- Starts at 0, increases by 1 with each portal entry
- Affects visual presentation (color shifts, particle effects)
- Affects pattern evolution logic

### Branch
A unique path through the recursion tree.
- Currently linear (single path)
- Reserved for future multi-path recursion feature
- Will enable divergent experiences based on choices

### Node
A single point of interaction in the recursion tree.
- Represents a decision or mutation event
- Actions: `pattern-mutation`, `portal-entry`, `session-start`, `session-complete`

### Memory (Session)
A completed recursive session stored in IndexedDB.
- Represents the user's journey through one complete recursion cycle
- Includes metadata: duration, interaction count, unique patterns
- Used for pattern evolution and constellation visualization

---

## üóÇÔ∏è Data Structures

### RecursionSession
```typescript
interface RecursionSession {
  id?: number;                  // Auto-generated by IndexedDB
  timestamp: number;            // Session start time (ms)
  depth: RecursionDepth;        // Max depth reached
  decisions: string[];          // Log of user decisions
  patterns: number[];           // Flattened history of all pattern states
  completed: boolean;           // Whether session reached completion
  metadata: SessionMetadata;    // Performance metrics
}
```

### SessionMetadata
```typescript
interface SessionMetadata {
  duration: number;             // Total session time (ms)
  interactionCount: number;     // Number of cell selections
  uniquePatterns: number;       // Unique pattern states encountered
}
```

### SessionStats
```typescript
interface SessionStats {
  totalSessions: number;        // Total sessions recorded
  avgDepth: number;             // Average recursion depth
  maxDepth: number;             // Deepest recursion reached
  completionRate: number;       // % of completed sessions (0-1)
  oldestSession: number | null; // Timestamp of first session
}
```

---

## üèóÔ∏è System Architecture

### Core Files

#### `src/lib/types.ts`
Central type definitions and vocabulary documentation.
- Exports all core types and interfaces
- Single source of truth for data structures
- Heavily documented with JSDoc comments

#### `src/lib/constants.ts`
Immutable configuration values.
- Pattern constants (initial pattern, cell states, completion threshold)
- Visual constants (colors, animations, transitions)
- Session constants (evolution history size)

#### `src/lib/recursionDB.ts`
IndexedDB persistence layer.
- Manages session storage and retrieval
- Session analytics calculations
- Pattern evolution engine

### Component Structure

```
src/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ RecursiveEngine.tsx      # Main orchestrator
‚îÇ   ‚îú‚îÄ‚îÄ PatternGrid.tsx          # Interactive cell grid
‚îÇ   ‚îú‚îÄ‚îÄ RecursionPortal.tsx      # Portal entry animation
‚îÇ   ‚îî‚îÄ‚îÄ MemoryConstellation.tsx  # Session visualization
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ Index.tsx                # Entry page
‚îÇ   ‚îî‚îÄ‚îÄ Memory.tsx               # Memory viewer page
‚îî‚îÄ‚îÄ lib/
    ‚îú‚îÄ‚îÄ types.ts                 # Type definitions
    ‚îú‚îÄ‚îÄ constants.ts             # Configuration
    ‚îî‚îÄ‚îÄ recursionDB.ts           # Database layer
```

---

## üîÑ Core Systems

### 1. Pattern Evolution Engine
**Location:** `src/lib/recursionDB.ts`

**Purpose:** Mutate patterns based on user's historical behavior.

**Algorithm:**
1. Fetch last 5 sessions from IndexedDB
2. Extract all pattern states from those sessions
3. Calculate mutation index using deterministic formula:
   ```typescript
   mutation = sessions
     .flatMap(s => s.patterns)
     .reduce((acc, val) => acc + (val % 3), 0) % currentPattern.length
   ```
4. Increment the cell at that index (wraps at 3 ‚Üí 0)
5. Return evolved pattern

**Result:** Seemingly "intelligent" evolution that reflects user behavior without being obvious.

### 2. Session Tracking
**Location:** `src/components/RecursiveEngine.tsx`

**Flow:**
1. `initSession()` - Create new session record
2. `handlePatternChange()` - Log each cell mutation
3. `handleEnterPortal()` - Trigger depth increase
4. `handleReset()` - Mark session complete, start new one

**Persistence:** All sessions stored in IndexedDB for later analysis.

### 3. Completion Detection
**Location:** `src/components/RecursiveEngine.tsx`

**Logic:**
```typescript
const isComplete = pattern.every(v => v >= COMPLETION_THRESHOLD);
```

**Behavior:**
- Portal appears when all cells reach state 3
- User can choose to descend deeper or reset
- Depth increases with each descent

### 4. Memory Visualization
**Location:** `src/components/MemoryConstellation.tsx`

**Layout:**
- Sessions arranged in circular constellation
- Node size = depth + interaction count
- Node color = depth-based hue shift
- Opacity = completion status (1.0 if complete, 0.5 if incomplete)
- Connecting lines between sequential sessions

---

## üé® Visual System

### Color Algorithm
```typescript
const hue = BASE_HUE + depth * HUE_SHIFT_PER_DEPTH;
// BASE_HUE = 180 (cyan)
// HUE_SHIFT_PER_DEPTH = 30
// Depth 0: cyan (180¬∞)
// Depth 1: blue (210¬∞)
// Depth 2: purple (240¬∞)
// Depth 3: magenta (270¬∞)
// etc.
```

### Animation Timings
- Portal transition: 1000ms
- Cell reveal: 50ms per cell (staggered)
- Completion detection: immediate
- Portal pulse: 2000ms cycle

---

## üìä Key Constants

| Constant | Value | Purpose |
|----------|-------|---------|
| `INITIAL_PATTERN` | `[0,1,2,1,0,1,2,3,0]` | Starting pattern for all sessions |
| `CELLS_TO_SELECT` | `3` | Number of cells to trigger mutation |
| `MAX_CELL_STATE` | `3` | Maximum cell value before wrap |
| `COMPLETION_THRESHOLD` | `3` | Cell state needed for completion |
| `BASE_HUE` | `180` | Starting color (cyan) |
| `HUE_SHIFT_PER_DEPTH` | `30` | Color shift per depth level |
| `EVOLUTION_HISTORY_SIZE` | `5` | Sessions analyzed for evolution |

---

## üßπ Removed Code (Phase 0 Cleanup)

### Deleted Interfaces/Types
- ‚ùå `MemoryNode` - Was defined but never used
- ‚ùå `decayFactor` field in `RecursionSession` - Planned feature, never implemented

### Deleted Functions
- ‚ùå `calculateDecay()` - Memory decay system (future feature)

### Deleted Variables
- ‚ùå `pulsePhase` in `RecursionPortal` - Set but never read

### Deleted Database Tables
- ‚ùå `memories` table - Was created but never populated

---

## üîÆ Future Architecture Notes

### Branching System (Phase N)
When implementing branching:
1. Activate `Branch` interface in `types.ts`
2. Store branch relationships in new `branches` table
3. Update `RecursiveEngine` to track branch IDs
4. Create branch visualization in constellation

### Matrix Grid (Potential)
If pattern structure needs to become 2D:
1. Change `Pattern` from `number[]` to `number[][]`
2. Update `PatternGrid` rendering logic
3. Adjust evolution algorithm for 2D traversal
4. Maintain backward compatibility via migration

### Memory Decay (Future)
If re-implementing decay:
1. Add `lastAccessed` field to `RecursionSession`
2. Restore `calculateDecay()` function
3. Apply decay factor to visualization opacity
4. Run decay calculation on app load

---

## ‚úÖ Phase 0 Deliverables Complete

- ‚úÖ Pattern data structure finalized (flat array)
- ‚úÖ Cell concept clearly defined (0-3 states)
- ‚úÖ Unused variables cleaned up (decayFactor, MemoryNode, pulsePhase)
- ‚úÖ Recursion vocabulary documented
- ‚úÖ Type system centralized in `types.ts`
- ‚úÖ Constants extracted to `constants.ts`
- ‚úÖ All code commented with clear intent

**Foundation Status:** üü¢ STABLE

Ready for Phase 1+ features (audio, branching, achievements, etc.).
